<app-user-navbar></app-user-navbar>

<div class="container mt-3">
  <!-- Sections with game progress -->
  <div *ngIf="isGameActive(); else gameNotActive">

    <!-- Sections with game state -->
    <table class="mat-table">
      <tr class="mat-header-row">
        <th class="mat-header-cell"> Game status </th>
        <th class="mat-header-cell"> Game round </th>
        <th class="mat-header-cell"> Your wallet state </th>
        <th class="mat-header-cell"> Decision made for current round? </th>
        <th class="mat-header-cell"> Round time remaining </th>
      </tr>

      <tr class="mat-row">
        <td class="mat-cell"> {{gameProgress.status}} </td>
        <td class="mat-cell"> {{gameProgress.round}} </td>
        <td class="mat-cell"> {{walletState}} </td>
        <td class="mat-cell"> {{alreadyDecided ? 'YES' : 'NO'}} </td>
        <td class="mat-cell"> {{gameProgress.timeLeftMs / 1000 | number: '1.0-0'}} s </td>
      </tr>
    </table>

    <!-- Vertical space -->
    <div style="margin-bottom:1cm;"></div>

    <!-- Sections with player decision inputs -->
    <mat-card>
      <mat-card-content>
        <form #configForm="ngForm">
          <div class="conf-margin input-group">
            <label class="label-title" for="contribution">Your contribution:</label>
            <input class="float-right conf-input"
                   id="contribution"
                   type="number" min="0" [max]="walletState" step="0.01"
                   [disabled]="alreadyDecided"
                   required
                   [(ngModel)]="currentContribution"
                   name="contribution"
                   #contribution="ngModel"
            />
            <mat-slider
              [disabled]="alreadyDecided"
              [min]="0"
              [max]="walletState"
              [step]="0.01"
              [thumbLabel]=true
              [(ngModel)]="currentContribution"
              name="contribution"
              #contribution="ngModel"></mat-slider>

            <div *ngIf="contribution.invalid && (contribution.dirty || contribution.touched)"
                 class="alert text-danger">
              <div *ngIf="contribution.errors?.required">
                Contribution is required. (Between 0 and your current wallet state).
              </div>
              <div *ngIf="contribution.errors?.min">
                Contribution cannot be negative.
              </div>
              <div *ngIf="contribution.errors?.max">
                Contribution cannot exceed your current wallet state.
              </div>
            </div>
          </div>

          <button class="m-3 btn btn-success custom-button" [disabled]="!configForm.valid || alreadyDecided" (click)="sendDecision()">
            Send
          </button>
        </form>
      </mat-card-content>
    </mat-card>
  </div>

  <ng-template #gameNotActive>
    <mat-card>The game cannot be played at this moment.</mat-card>
  </ng-template>

  <mat-card *ngIf="historyTableData.length > 0; else noData">
      <table mat-table [dataSource]="historyTableData">
        <ng-container [matColumnDef]="column" *ngFor="let column of historyTableColumns"
                      [sticky]="column === roundColumnName" [stickyEnd]="column === payoffColumnName">
          <th mat-header-cell *matHeaderCellDef> {{column + (column === getUsername() ? " (you)" : "")}} </th>
          <td mat-cell *matCellDef="let row"> {{row.get(column) || ''}} </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="historyTableColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: historyTableColumns;"></tr>
      </table>
  </mat-card>

    <ng-template #noData>
      <mat-card>No data is available for this game.</mat-card>
    </ng-template>

  <mat-card *ngIf="historyTableData.length > 0">
    <mat-card-content *ngIf="charts">
      <button mat-raised-button color="primary" (click)="downloadChartsAsPDF()">Download as PDF</button>
      <ng-container *ngFor="let chart of charts">
        <canvas class="chart"
                baseChart
                width="100%"
                height="100%"
                [chartType]="'line'"
                [legend]="true"
                [labels]="chart.chartLabels"
                [datasets]="chart.chartData"
                [options]="chartOptions">
        </canvas>
      </ng-container>
    </mat-card-content>
  </mat-card>

</div>
